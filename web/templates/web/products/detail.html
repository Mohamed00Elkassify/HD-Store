{% extends "web/base.html" %}
{% load static web_tags %}

{% block title %}{{ product.name|loc:lang }} â€” HD Store{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
  <!-- Breadcrumbs -->
  <nav class="mb-6 flex items-center gap-2 text-sm text-muted-foreground">
    <a href="{% url 'web:home' lang %}" class="hover:text-foreground">{{ t.common.home }}</a>
    <i data-lucide="chevron-right" class="h-3 w-3 {% if is_rtl %}rotate-180{% endif %}"></i>
    <a href="{% url 'web:products' lang %}" class="hover:text-foreground">{{ t.common.products }}</a>
    <i data-lucide="chevron-right" class="h-3 w-3 {% if is_rtl %}rotate-180{% endif %}"></i>
    <span class="text-foreground">{{ product.name|loc:lang }}</span>
  </nav>

  <div class="grid gap-8 lg:grid-cols-2">
    <!-- Image -->
    <div class="relative aspect-[4/3] overflow-hidden rounded-lg bg-muted">
      {% if product.image_url %}
      <img src="{{ product.image_url }}" alt="{{ product.name|loc:lang }}" class="h-full w-full object-contain p-4">
      {% else %}
      <div class="flex h-full items-center justify-center">
        <i data-lucide="laptop" class="h-32 w-32 text-muted-foreground/20"></i>
      </div>
      {% endif %}
      <!-- Tags -->
      {% if product.tags %}
      <div class="absolute {% if is_rtl %}right-3{% else %}left-3{% endif %} top-3 flex flex-col gap-1">
        {% for tag in product.tags %}
        <span class="inline-flex items-center rounded-full bg-primary px-3 py-1 text-xs font-medium text-primary-foreground">{{ tag }}</span>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- Info -->
    <div class="space-y-6">
      <div>
        <p class="text-sm font-medium text-muted-foreground">{{ product.brand }}</p>
        <h1 class="mt-1 font-heading text-2xl font-bold sm:text-3xl">{{ product.name|loc:lang }}</h1>
      </div>

      <!-- Badges row -->
      <div class="flex flex-wrap gap-2">
        {% if product.inStock %}
        <span class="inline-flex items-center gap-1 rounded-full bg-green-100 px-3 py-1 text-xs font-medium text-green-700 dark:bg-green-900/30 dark:text-green-400">
          <i data-lucide="check-circle" class="h-3 w-3"></i> {{ t.common.inStock }}
        </span>
        {% else %}
        <span class="inline-flex items-center gap-1 rounded-full bg-red-100 px-3 py-1 text-xs font-medium text-red-700 dark:bg-red-900/30 dark:text-red-400">
          <i data-lucide="x-circle" class="h-3 w-3"></i> {{ t.common.outOfStock }}
        </span>
        {% endif %}
        <span class="inline-flex items-center rounded-full bg-secondary px-3 py-1 text-xs font-medium text-secondary-foreground">{{ t.common.grade }} {{ product.grade }}</span>
        <span class="inline-flex items-center rounded-full bg-secondary px-3 py-1 text-xs font-medium text-secondary-foreground">{{ product.condition }}</span>
        {% if product.includesCharger %}
        <span class="inline-flex items-center gap-1 rounded-full bg-blue-100 px-3 py-1 text-xs font-medium text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">
          <i data-lucide="plug" class="h-3 w-3"></i> {{ t.common.includesCharger }}
        </span>
        {% else %}
        <span class="inline-flex items-center gap-1 rounded-full bg-orange-100 px-3 py-1 text-xs font-medium text-orange-700 dark:bg-orange-900/30 dark:text-orange-400">
          {{ t.common.noCharger }}
        </span>
        {% endif %}
        <span class="inline-flex items-center rounded-full bg-secondary px-3 py-1 text-xs font-medium text-secondary-foreground">
          <i data-lucide="keyboard" class="h-3 w-3 {% if is_rtl %}ml-1{% else %}mr-1{% endif %}"></i> {{ product.keyboardLayout }}
        </span>
      </div>

      <!-- Price -->
      <div class="flex items-baseline gap-3">
        <span class="text-3xl font-bold text-primary">{{ product.priceEGP|price }}</span>
        <span class="text-lg text-muted-foreground">{{ t.common.egp }}</span>
        {% if product.oldPriceEGP %}
        <span class="text-lg text-muted-foreground line-through">{{ product.oldPriceEGP|price }}</span>
        {% endif %}
      </div>

      <!-- CTA buttons -->
      <div class="flex flex-col gap-3 sm:flex-row">
        <form method="post" action="{% url 'web:cart_add' lang %}" class="flex-1">
          {% csrf_token %}
          <input type="hidden" name="item_code" value="{{ product.item_code }}">
          <button type="submit" {% if not product.inStock %}disabled{% endif %}
                  class="inline-flex w-full items-center justify-center gap-2 rounded-md bg-primary px-6 py-3 text-sm font-medium text-primary-foreground shadow hover:bg-primary/90 disabled:pointer-events-none disabled:opacity-50">
            <i data-lucide="shopping-cart" class="h-4 w-4"></i>
            {{ t.common.addToCart }}
          </button>
        </form>
        <form method="post" action="{% url 'web:cart_add' lang %}?next=checkout" class="flex-1">
          {% csrf_token %}
          <input type="hidden" name="item_code" value="{{ product.item_code }}">
          <button type="submit" {% if not product.inStock %}disabled{% endif %}
                  class="inline-flex w-full items-center justify-center gap-2 rounded-md border border-input bg-background px-6 py-3 text-sm font-medium shadow-sm hover:bg-accent disabled:pointer-events-none disabled:opacity-50">
            {{ t.common.buyNow }}
          </button>
        </form>
      </div>

      <!-- Specs Grid / Description -->
      {% if spec_labels %}
      <div class="rounded-lg border bg-card">
        <div class="grid grid-cols-2 gap-px bg-border">
          {% for spec_key, spec_label in spec_labels.items %}
          <div class="bg-card p-3">
            <p class="text-xs text-muted-foreground">{{ spec_label }}</p>
            <p class="mt-0.5 text-sm font-medium">{{ product.specs|get_item:spec_key }}</p>
          </div>
          {% endfor %}
        </div>
      </div>
      {% elif product.description %}
      <div class="rounded-lg border bg-card p-4">
        <p class="text-xs text-muted-foreground mb-1">Description</p>
        <div class="text-sm leading-relaxed">{{ product.description|safe }}</div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Tabbed Info -->
  <div class="mt-12" x-data="{ activeTab: 'specs' }">
    <div class="flex border-b">
      <button @click="activeTab = 'specs'" :class="activeTab === 'specs' ? 'border-primary text-foreground' : 'border-transparent text-muted-foreground hover:text-foreground'"
              class="border-b-2 px-4 py-3 text-sm font-medium transition-colors">
        {{ t.product.specifications }}
      </button>
      <button @click="activeTab = 'shipping'" :class="activeTab === 'shipping' ? 'border-primary text-foreground' : 'border-transparent text-muted-foreground hover:text-foreground'"
              class="border-b-2 px-4 py-3 text-sm font-medium transition-colors">
        {{ t.product.shippingDelivery }}
      </button>
      <button @click="activeTab = 'warranty'" :class="activeTab === 'warranty' ? 'border-primary text-foreground' : 'border-transparent text-muted-foreground hover:text-foreground'"
              class="border-b-2 px-4 py-3 text-sm font-medium transition-colors">
        {{ t.product.warrantyReturns }}
      </button>
    </div>

    <div class="py-6">
      <div x-show="activeTab === 'specs'">
        {% if spec_labels %}
        <div class="grid gap-4 sm:grid-cols-2">
          {% for spec_key, spec_label in spec_labels.items %}
          <div class="flex items-center gap-3 rounded-lg border p-3">
            <div class="flex h-8 w-8 items-center justify-center rounded-md bg-primary/10">
              <i data-lucide="cpu" class="h-4 w-4 text-primary"></i>
            </div>
            <div>
              <p class="text-xs text-muted-foreground">{{ spec_label }}</p>
              <p class="text-sm font-medium">{{ product.specs|get_item:spec_key }}</p>
            </div>
          </div>
          {% endfor %}
        </div>
        {% elif product.description %}
        <div class="text-sm leading-relaxed text-muted-foreground">{{ product.description|safe }}</div>
        {% else %}
        <p class="text-sm text-muted-foreground">No specifications available.</p>
        {% endif %}
      </div>

      <div x-show="activeTab === 'shipping'" style="display:none">
        <p class="text-sm leading-relaxed text-muted-foreground">{{ t.product.shippingInfo }}</p>
      </div>

      <div x-show="activeTab === 'warranty'" style="display:none">
        <p class="text-sm leading-relaxed text-muted-foreground">{{ t.product.warrantyInfo }}</p>
        <a href="{% url 'web:warranty' lang %}" class="mt-3 inline-flex text-sm font-medium text-primary hover:underline">
          {{ t.product.readMore }} &rarr;
        </a>
      </div>
    </div>
  </div>

  <!-- Related Products -->
  {% if related_products %}
  <section class="mt-12">
    <h2 class="mb-6 font-heading text-xl font-bold">{{ t.product.relatedProducts }}</h2>
    <div class="grid grid-cols-2 gap-4 sm:gap-6 lg:grid-cols-4">
      {% for product in related_products %}
        {% include "web/partials/_product_card.html" with product=product %}
      {% endfor %}
    </div>
  </section>
  {% endif %}
</div>
{% endblock %}
